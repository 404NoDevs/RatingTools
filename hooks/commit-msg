#!/bin/bash

# æ—¶æœºï¼šåœ¨ç”¨æˆ·è¾“å…¥æäº¤æ¶ˆæ¯åè§¦å‘ã€‚
# ç”¨é€”ï¼šéªŒè¯æäº¤æ¶ˆæ¯æ ¼å¼ï¼ˆå¦‚æ˜¯å¦ç¬¦åˆçº¦å®šå¼æäº¤ï¼‰ã€‚
# æ³¨æ„ï¼šéé›¶é€€å‡ºä¼šæ‹’ç»æäº¤ã€‚

echo "=== é’©å­å¼€å§‹æ‰§è¡Œ === "

changed_files=$(git diff --cached --name-only)
echo "ğŸ“ å˜æ›´æ–‡ä»¶:"
echo "$changed_files"

modules=()
for file in $changed_files; do
    echo "ğŸ” æ­£åœ¨å¤„ç†: $file"
    
    # æ’é™¤ version.md å’Œä¸´æ—¶æ–‡ä»¶
    if [[ $file == *"/version.md" || $file == *"~" ]]; then
        echo "â­ï¸  è·³è¿‡æ–‡ä»¶: $file"
        continue
    fi
    
    # æå–æ¨¡å—ç›®å½•ï¼ˆå…¼å®¹æ ¹ç›®å½•ï¼‰
    module=$(dirname "$file")
    if [ "$module" = "." ]; then
        module="root"
    fi
    
    echo "ğŸ“¦ æ¨¡å—è·¯å¾„: $module"
    
    if [ -n "$module" ]; then
        if [[ ! " ${modules[@]} " =~ " ${module} " ]]; then
            modules+=("$module")
            echo "âœ… æ–°å¢æ¨¡å—: $module"
        fi
    fi
done

if [ ${#modules[@]} -gt 0 ]; then
    echo "æ—¥å¿—è·¯å¾„: $1"
    commit_msg=$(cat "$1")
    echo "ğŸ“ æäº¤ä¿¡æ¯: $commit_msg"
    
    for module in "${modules[@]}"; do
        # å¤„ç†æ ¹ç›®å½•ç‰¹æ®Šé€»è¾‘
        if [ "$module" = "root" ]; then
            version_file="version.md"
        else
            version_file="$module/version.md"
        fi
        
        echo "ğŸ› ï¸  æ›´æ–°: $version_file"
        echo "## $(date +'%Y-%m-%d %H:%M:%S')" >> "$version_file"
        echo "$commit_msg" >> "$version_file"
        echo "" >> "$version_file"
        git add "$version_file"
    done
else
    echo "â„¹ï¸  æ²¡æœ‰éœ€è¦æ›´æ–°çš„æ¨¡å—"
fi

if [ ${#modules[@]} -gt 0 ]; then
    # ä½¿ç”¨åº•å±‚å‘½ä»¤åˆ›å»ºæ–°æäº¤
    new_tree=$(git write-tree)
    parent_commit=$(git rev-parse HEAD)
    new_commit=$(echo "Your commit message" | git commit-tree $new_tree -p $parent_commit)
    
    # åŸå­æ€§æ›´æ–°å¼•ç”¨
    git update-ref -m "commit-msg hook update" HEAD $new_commit
fi

echo "=== æ‰§è¡Œå®Œæˆ ==="
exit 0